name: Build

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: '1'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: '1'
  DOTNET_NOLOGO: 'true'

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Run tests
        run: dotnet test --no-build --configuration Release --logger "trx;LogFileName=test-results.trx" --filter "Category!=RequiresDisplay"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/test-results.trx'

  build-windows:
    name: Build (Windows)
    runs-on: windows-latest
    needs: test
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        shell: pwsh
        run: dotnet restore

      - name: Extract version
        id: extract_version_windows
        shell: pwsh
        run: |
          [xml]$csproj = Get-Content "PoorCraftUltra.csproj"
          $versionNode = $csproj.Project.PropertyGroup | Where-Object { $_.Version } | Select-Object -First 1
          if (-not $versionNode) { throw "Version not found in project file" }
          $version = $versionNode.Version
          if (-not $version) { throw "Version node empty" }
          "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Run Windows build script
        shell: pwsh
        run: pwsh build/windows/build.ps1

      - name: Install NSIS
        shell: pwsh
        run: choco install nsis -y

      - name: Create installer
        shell: pwsh
        run: |
          if (-not $env:VI_NUM_VERSION) {
            throw "VI_NUM_VERSION environment variable not set."
          }
          makensis /DVERSION=${{ env.VERSION }} /DVI_NUM_VERSION=$env:VI_NUM_VERSION build/windows/installer.nsi

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: poorcraftultra-windows-${{ env.VERSION }}
          path: |
            build/windows/output/PoorCraftUltra-v${{ env.VERSION }}-windows-x64-portable.zip
            build/windows/output/PoorCraftUltra-v${{ env.VERSION }}-windows-x64-installer.exe

  build-linux:
    name: Build (Linux)
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install packaging dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev fuse

      - name: Restore
        run: dotnet restore

      - name: Extract version
        id: extract_version_linux
        run: |
          VERSION=$(grep -oP '(?<=<Version>).*?(?=</Version>)' PoorCraftUltra.csproj | head -n1)
          if [ -z "$VERSION" ]; then
            echo "Version not found" >&2
            exit 1
          fi
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Run Linux build script
        run: bash build/linux/build.sh

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: poorcraftultra-linux-${{ env.VERSION }}
          path: |
            build/linux/output/poorcraftultra_${{ env.VERSION }}_amd64.deb
            build/linux/output/PoorCraftUltra-v${{ env.VERSION }}-linux-x86_64.AppImage
            build/linux/output/PoorCraftUltra-v${{ env.VERSION }}-linux-x64-portable.tar.gz

  build-macos:
    name: Build (macOS)
    runs-on: macos-latest
    needs: test
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore

      - name: Extract version
        id: extract_version_macos
        run: |
          VERSION=$(grep -oE '<Version>[^<]+' PoorCraftUltra.csproj | head -n1 | sed 's/<Version>//')
          if [ -z "$VERSION" ]; then
            echo "Version not found" >&2
            exit 1
          fi
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Run macOS build script
        run: bash build/macos/build.sh

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: poorcraftultra-macos-${{ env.VERSION }}
          path: |
            build/macos/output/PoorCraftUltra-v${{ env.VERSION }}-macos-x64.dmg
            build/macos/output/PoorCraftUltra-v${{ env.VERSION }}-macos-x64-portable.zip
