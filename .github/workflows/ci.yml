name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: ${{ matrix.os }} / ${{ matrix.compiler }} / ${{ matrix.build_type }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        compiler: [gcc, clang, msvc]
        build_type: [Debug, Release]
        exclude:
          - os: windows-latest
            compiler: gcc
          - os: windows-latest
            compiler: clang
          - os: ubuntu-latest
            compiler: msvc
          - os: macos-latest
            compiler: msvc
        include:
          - os: ubuntu-latest
            compiler: gcc
            build_type: Debug
            configure_preset: linux-gcc
            build_preset: linux-gcc-debug
            test_preset: linux-gcc-debug
          - os: ubuntu-latest
            compiler: gcc
            build_type: Release
            configure_preset: linux-gcc
            build_preset: linux-gcc-release
            test_preset: linux-gcc-release
          - os: ubuntu-latest
            compiler: clang
            build_type: Debug
            configure_preset: linux-clang
            build_preset: linux-clang-debug
            test_preset: linux-clang-debug
          - os: ubuntu-latest
            compiler: clang
            build_type: Release
            configure_preset: linux-clang
            build_preset: linux-clang-release
            test_preset: linux-clang-release
          - os: windows-latest
            compiler: msvc
            build_type: Debug
            configure_preset: windows-msvc
            build_preset: windows-msvc-debug
            test_preset: windows-msvc-debug
          - os: windows-latest
            compiler: msvc
            build_type: Release
            configure_preset: windows-msvc
            build_preset: windows-msvc-release
            test_preset: windows-msvc-release
          - os: macos-latest
            compiler: clang
            build_type: Debug
            configure_preset: macos-clang
            build_preset: macos-clang-debug
            test_preset: macos-clang-debug
          - os: macos-latest
            compiler: clang
            build_type: Release
            configure_preset: macos-clang
            build_preset: macos-clang-release
            test_preset: macos-clang-release

    env:
      SCCACHE_GHA_ENABLED: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up CMake
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: "3.31.0"

      - name: Install Ninja
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build

      - name: Install Ninja (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install ninja

      - name: Install GCC
        if: matrix.os == 'ubuntu-latest' && matrix.compiler == 'gcc'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Install Clang
        if: matrix.os == 'ubuntu-latest' && matrix.compiler == 'clang'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang

      - name: Install graphics stack (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            mesa-utils \
            libgl1-mesa-dri \
            libegl1-mesa \
            libglu1-mesa-dev \
            mesa-vulkan-drivers \
            vulkan-tools

      - name: Set up MSVC environment
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Set up sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure
        run: cmake --preset ${{ matrix.configure_preset }} -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}

      - name: Build
        run: cmake --build --preset ${{ matrix.build_preset }}

      - name: Smoke run PoorCraft
        shell: bash
        run: |
          set -euo pipefail
          case "${{ matrix.os }}" in
            ubuntu-latest)
              Xvfb :99 -screen 0 1920x1080x24 &
              xvfb_pid=$!
              trap 'kill $xvfb_pid' EXIT
              export DISPLAY=:99
              export VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/lvp_icd.x86_64.json
              bin="./build/${{ matrix.configure_preset }}/poorcraft"
              ;;
            windows-latest)
              bin="./build/windows-msvc/${{ matrix.build_type }}/poorcraft.exe"
              ;;
            macos-latest)
              bin="./build/macos-clang/poorcraft.app/Contents/MacOS/poorcraft"
              ;;
            *)
              echo "Unsupported OS: ${{ matrix.os }}"
              exit 1
              ;;
          esac

          if [[ ! -f "$bin" ]]; then
              echo "PoorCraft binary not found at $bin"
              find ./build -maxdepth 4 -type f -name 'poorcraft*'
              exit 1
          fi

          echo "Running $bin"
          output="$($bin)"
          echo "::group::PoorCraft stdout"
          printf '%s\n' "$output"
          echo "::endgroup::"

      - name: Graphics diagnostics (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          vulkaninfo --summary || true
          glxinfo -B || true

      - name: Test (Linux headless)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          set -euo pipefail
          Xvfb :99 -screen 0 1920x1080x24 &
          export DISPLAY=:99
          export VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/lvp_icd.x86_64.json
          ctest --test-dir build --build-config ${{ matrix.build_type }} --output-on-failure

      - name: Test
        if: matrix.os != 'ubuntu-latest'
        run: ctest --preset ${{ matrix.test_preset }}

      - name: Upload artifacts
        if: matrix.build_type == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: poorcraft-${{ matrix.os }}-${{ matrix.compiler }}
          path: |
            build/${{ matrix.configure_preset }}
